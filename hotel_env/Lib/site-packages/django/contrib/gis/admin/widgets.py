

import logging 
import warnings 

from django .contrib .gis .gdal import GDALException 
from django .contrib .gis .geos import GEOSException ,GEOSGeometry 
from django .forms .widgets import Textarea 
from django .utils import translation 
from django .utils .deprecation import RemovedInDjango50Warning 





geo_context ={"LANGUAGE_BIDI":translation .get_language_bidi ()}
logger =logging .getLogger ("django.contrib.gis")


class OpenLayersWidget (Textarea ):
    """
    Render an OpenLayers map using the WKT of the geometry.
    """

    def __init__ (self ,*args ,**kwargs ):
        warnings .warn (
        "django.contrib.gis.admin.OpenLayersWidget is deprecated.",
        RemovedInDjango50Warning ,
        stacklevel =2 ,
        )
        super ().__init__ (*args ,**kwargs )

    def get_context (self ,name ,value ,attrs ):

        if attrs :
            self .params .update (attrs )
            self .params ["editable"]=self .params ["modifiable"]
        else :
            self .params ["editable"]=True 




        self .params ["wkt"]=""



        if value and isinstance (value ,str ):
            try :
                value =GEOSGeometry (value )
            except (GEOSException ,ValueError )as err :
                logger .error ("Error creating geometry from value '%s' (%s)",value ,err )
                value =None 

        if (
        value 
        and value .geom_type .upper ()!=self .geom_type 
        and self .geom_type !="GEOMETRY"
        ):
            value =None 


        self .params ["map_options"]=self .map_options ()




        self .params ["name"]=name 


        js_safe_name =self .params ["name"].replace ("-","_")
        self .params ["module"]="geodjango_%s"%js_safe_name 

        if value :


            srid =self .params ["srid"]
            if value .srid !=srid :
                try :
                    ogr =value .ogr 
                    ogr .transform (srid )
                    wkt =ogr .wkt 
                except GDALException as err :
                    logger .error (
                    "Error transforming geometry from srid '%s' to srid '%s' (%s)",
                    value .srid ,
                    srid ,
                    err ,
                    )
                    wkt =""
            else :
                wkt =value .wkt 



            self .params ["wkt"]=wkt 

        self .params .update (geo_context )
        return self .params 

    def map_options (self ):
        """Build the map options hash for the OpenLayers template."""


        def ol_bounds (extent ):
            return "new OpenLayers.Bounds(%s)"%extent 

        def ol_projection (srid ):
            return 'new OpenLayers.Projection("EPSG:%s")'%srid 



        map_types =[
        ("srid","projection","srid"),
        ("display_srid","displayProjection","srid"),
        ("units","units",str ),
        ("max_resolution","maxResolution",float ),
        ("max_extent","maxExtent","bounds"),
        ("num_zoom","numZoomLevels",int ),
        ("max_zoom","maxZoomLevels",int ),
        ("min_zoom","minZoomLevel",int ),
        ]


        map_options ={}
        for param_name ,js_name ,option_type in map_types :
            if self .params .get (param_name ,False ):
                if option_type =="srid":
                    value =ol_projection (self .params [param_name ])
                elif option_type =="bounds":
                    value =ol_bounds (self .params [param_name ])
                elif option_type in (float ,int ):
                    value =self .params [param_name ]
                elif option_type in (str ,):
                    value ='"%s"'%self .params [param_name ]
                else :
                    raise TypeError 
                map_options [js_name ]=value 
        return map_options 
