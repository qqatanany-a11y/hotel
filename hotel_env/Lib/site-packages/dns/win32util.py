import sys 

import dns ._features 

if sys .platform =="win32":
    from typing import Any 

    import dns .name 

    _prefer_wmi =True 

    import winreg 


    try :
        _ =WindowsError 
    except NameError :
        WindowsError =Exception 

    if dns ._features .have ("wmi"):
        import threading 

        import pythoncom 
        import wmi 

        _have_wmi =True 
    else :
        _have_wmi =False 

    def _config_domain (domain ):



        if domain .startswith ("."):
            domain =domain [1 :]
        return dns .name .from_text (domain )

    class DnsInfo :
        def __init__ (self ):
            self .domain =None 
            self .nameservers =[]
            self .search =[]

    if _have_wmi :

        class _WMIGetter (threading .Thread ):

            def __init__ (self ):
                super ().__init__ ()
                self .info =DnsInfo ()

            def run (self ):
                pythoncom .CoInitialize ()
                try :
                    system =wmi .WMI ()
                    for interface in system .Win32_NetworkAdapterConfiguration ():
                        if interface .IPEnabled and interface .DNSServerSearchOrder :
                            self .info .nameservers =list (interface .DNSServerSearchOrder )
                            if interface .DNSDomain :
                                self .info .domain =_config_domain (interface .DNSDomain )
                            if interface .DNSDomainSuffixSearchOrder :
                                self .info .search =[
                                _config_domain (x )
                                for x in interface .DNSDomainSuffixSearchOrder 
                                ]
                            break 
                finally :
                    pythoncom .CoUninitialize ()

            def get (self ):


                self .start ()
                self .join ()
                return self .info 

    else :

        class _WMIGetter :
            pass 

    class _RegistryGetter :
        def __init__ (self ):
            self .info =DnsInfo ()

        def _split (self ,text ):





            return text .replace (","," ").split ()

        def _config_nameservers (self ,nameservers ):
            for ns in self ._split (nameservers ):
                if ns not in self .info .nameservers :
                    self .info .nameservers .append (ns )

        def _config_search (self ,search ):
            for s in self ._split (search ):
                s =_config_domain (s )
                if s not in self .info .search :
                    self .info .search .append (s )

        def _config_fromkey (self ,key ,always_try_domain ):
            try :
                servers ,_ =winreg .QueryValueEx (key ,"NameServer")
            except WindowsError :
                servers =None 
            if servers :
                self ._config_nameservers (servers )
            if servers or always_try_domain :
                try :
                    dom ,_ =winreg .QueryValueEx (key ,"Domain")
                    if dom :
                        self .info .domain =_config_domain (dom )
                except WindowsError :
                    pass 
            else :
                try :
                    servers ,_ =winreg .QueryValueEx (key ,"DhcpNameServer")
                except WindowsError :
                    servers =None 
                if servers :
                    self ._config_nameservers (servers )
                    try :
                        dom ,_ =winreg .QueryValueEx (key ,"DhcpDomain")
                        if dom :
                            self .info .domain =_config_domain (dom )
                    except WindowsError :
                        pass 
            try :
                search ,_ =winreg .QueryValueEx (key ,"SearchList")
            except WindowsError :
                search =None 
            if search is None :
                try :
                    search ,_ =winreg .QueryValueEx (key ,"DhcpSearchList")
                except WindowsError :
                    search =None 
            if search :
                self ._config_search (search )

        def _is_nic_enabled (self ,lm ,guid ):





            try :


                connection_key =winreg .OpenKey (
                lm ,
                r"SYSTEM\CurrentControlSet\Control\Network"
                r"\{4D36E972-E325-11CE-BFC1-08002BE10318}"
                rf"\{guid}\Connection",
                )

                try :

                    (pnp_id ,ttype )=winreg .QueryValueEx (
                    connection_key ,"PnpInstanceID"
                    )

                    if ttype !=winreg .REG_SZ :
                        raise ValueError 

                    device_key =winreg .OpenKey (
                    lm ,rf"SYSTEM\CurrentControlSet\Enum\{pnp_id}"
                    )

                    try :

                        (flags ,ttype )=winreg .QueryValueEx (device_key ,"ConfigFlags")

                        if ttype !=winreg .REG_DWORD :
                            raise ValueError 








                        return not flags &0x1 

                    finally :
                        device_key .Close ()
                finally :
                    connection_key .Close ()
            except Exception :
                return False 

        def get (self ):
            """Extract resolver configuration from the Windows registry."""

            lm =winreg .ConnectRegistry (None ,winreg .HKEY_LOCAL_MACHINE )
            try :
                tcp_params =winreg .OpenKey (
                lm ,r"SYSTEM\CurrentControlSet\Services\Tcpip\Parameters"
                )
                try :
                    self ._config_fromkey (tcp_params ,True )
                finally :
                    tcp_params .Close ()
                interfaces =winreg .OpenKey (
                lm ,
                r"SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces",
                )
                try :
                    i =0 
                    while True :
                        try :
                            guid =winreg .EnumKey (interfaces ,i )
                            i +=1 
                            key =winreg .OpenKey (interfaces ,guid )
                            try :
                                if not self ._is_nic_enabled (lm ,guid ):
                                    continue 
                                self ._config_fromkey (key ,False )
                            finally :
                                key .Close ()
                        except OSError :
                            break 
                finally :
                    interfaces .Close ()
            finally :
                lm .Close ()
            return self .info 

    _getter_class :Any 
    if _have_wmi and _prefer_wmi :
        _getter_class =_WMIGetter 
    else :
        _getter_class =_RegistryGetter 

    def get_dns_info ():
        """Extract resolver configuration."""
        getter =_getter_class ()
        return getter .get ()
