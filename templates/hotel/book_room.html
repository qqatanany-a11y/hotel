{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}{% trans "Room Booking" %} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8">
            <h1 class="mb-4">
                <i class="fas fa-calendar-plus me-2"></i>{% trans "Room Booking" %}
            </h1>

            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bed me-2"></i>{% trans "Room Details" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            {% if room.room_type.image %}
                            <img src="{{ room.room_type.image.url }}"
                                 class="img-fluid rounded"
                                 alt="{{ room.room_type.get_name_display }}">
                            {% else %}
                            <img src="{% static 'images/luxury-modern-hotel-bedroom-suite-elegant-decor.jpg' %}"
                                 class="img-fluid rounded"
                                 alt="{{ room.room_type.get_name_display }}">
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <h4>{{ room.room_type.get_name_display }}</h4>
                            <p class="text-muted">{{ room.room_type.description }}</p>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>{% trans "Room Number:" %}</strong> {{ room.room_number }}
                                </div>
                                <div class="col-6">
                                    <strong>{% trans "Floor:" %}</strong> {{ room.floor }}
                                </div>
                                <div class="col-6">
                                    <strong>{% trans "Base Price:" %}</strong> {{ room.room_type.base_price }} {% trans "JOD/night" %}
                                </div>
                                <div class="col-6">
                                    <strong>{% trans "Maximum:" %}</strong> {{ room.room_type.max_occupancy }} {% trans "person" %}
                                </div>
                            </div>

                            {% if room.room_type.amenities %}
                            <div>
                                <strong>{% trans "Amenities:" %}</strong>
                                <div class="d-flex flex-wrap mt-2">
                                    {% for amenity in room.room_type.get_amenities_list %}
                                    <span class="badge bg-light text-dark me-1 mb-1">
                                        <i class="fas fa-check me-1"></i>{{ amenity }}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>{% trans "Booking Details" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% crispy form %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            
            <div class="card shadow-sm mb-4 sticky-top" style="top: 100px;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>{% trans "Cost Summary" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div id="price-summary">
                        {% if estimated_price %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>{% trans "Room Price:" %}</span>
                            <span id="room-price">{{ estimated_price }} {% trans "JOD" %}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>{% trans "Additional Services:" %}</span>
                            <span id="services-price">0 {% trans "JOD" %}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>{% trans "Total:" %}</span>
                            <span id="total-price" class="text-success">{{ estimated_price }} {% trans "JOD" %}</span>
                        </div>
                        {% else %}
                        <p class="text-muted text-center">
                            {% trans "Cost will be calculated after entering dates" %}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            
            {% if additional_services %}
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>{% trans "Available Additional Services" %}
                    </h6>
                </div>
                <div class="card-body">
                    {% for service in additional_services %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            {% if service.icon %}
                            <i class="fas fa-{{ service.icon }} me-2"></i>
                            {% endif %}
                            <strong>{{ service.name }}</strong>
                            {% if service.description %}
                            <br><small class="text-muted">{{ service.description }}</small>
                            {% endif %}
                        </div>
                        <span class="fw-bold">{{ service.price }} {% trans "JOD" %}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const roomPrice = {{ room.room_type.base_price }};
    const servicesData = [
        {% for service in additional_services %}
        {id: {{ service.id }}, price: {{ service.price }}},
        {% endfor %}
    ];

    function updatePriceCalculation() {
        const checkInDate = document.querySelector('input[name="check_in_date"]');
        const checkOutDate = document.querySelector('input[name="check_out_date"]');
        const serviceCheckboxes = document.querySelectorAll('input[name="additional_services"]:checked');

        if (checkInDate.value && checkOutDate.value) {
            // Calculate nights
            const checkIn = new Date(checkInDate.value);
            const checkOut = new Date(checkOutDate.value);
            const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));

            if (nights > 0) {
                // Calculate room price
                const totalRoomPrice = roomPrice * nights;

                // Calculate services price
                let servicesPrice = 0;
                serviceCheckboxes.forEach(checkbox => {
                    const serviceId = parseInt(checkbox.value);
                    const service = servicesData.find(s => s.id === serviceId);
                    if (service) {
                        servicesPrice += service.price;
                    }
                });

                // Update display
                document.getElementById('room-price').textContent = totalRoomPrice + ' {% trans "JOD" %}';
                document.getElementById('services-price').textContent = servicesPrice + ' {% trans "JOD" %}';
                document.getElementById('total-price').textContent = (totalRoomPrice + servicesPrice) + ' {% trans "JOD" %}';
            }
        }
    }

    // Attach event listeners
    document.querySelector('input[name="check_in_date"]')?.addEventListener('change', updatePriceCalculation);
    document.querySelector('input[name="check_out_date"]')?.addEventListener('change', updatePriceCalculation);

    document.querySelectorAll('input[name="additional_services"]').forEach(checkbox => {
        checkbox.addEventListener('change', updatePriceCalculation);
    });

    // Initial calculation
    updatePriceCalculation();
});
</script>
{% endblock %}

