{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Payment" %} - {{ booking.booking_id }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            
            <div class="text-center mb-4">
                <i class="fas fa-credit-card fa-3x text-success mb-3"></i>
                <h2 class="mb-2">{% trans "Complete Your Payment" %}</h2>
                <p class="text-muted">{% trans "Booking ID" %}: <strong>{{ booking.booking_id }}</strong></p>
            </div>

            
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>{% trans "Booking Summary" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>{% trans "Room" %}:</strong> {{ booking.room.room_type.get_name_display }}</p>
                            <p><strong>{% trans "Room Number" %}:</strong> {{ booking.room.room_number }}</p>
                            <p><strong>{% trans "Guest Name" %}:</strong> {{ booking.guest.first_name }} {{ booking.guest.last_name }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>{% trans "Check-in Date" %}:</strong> {{ booking.check_in_date|date:"d M Y" }}</p>
                            <p><strong>{% trans "Check-out Date" %}:</strong> {{ booking.check_out_date|date:"d M Y" }}</p>
                            <p><strong>{% trans "Number of Nights" %}:</strong> {{ booking.duration }}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="text-end">
                        <h4 class="text-success">
                            <strong>{% trans "Total Amount" %}: ${{ booking.total_amount }}</strong>
                        </h4>
                    </div>
                </div>
            </div>

            
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lock me-2"></i>{% trans "Select Payment Method" %}
                    </h5>
                </div>

                <div class="card-body">
                    <form method="post" id="payment-form">
                        {% csrf_token %}

                        
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check p-3 border rounded text-center">
                                        <input class="form-check-input me-2" type="radio" name="payment_method" id="visa_option" value="visa" required>
                                        <label class="form-check-label" for="visa_option">
                                            <i class="fas fa-credit-card fa-2x text-primary d-block mb-2"></i>
                                            <strong>{% trans "Visa" %}</strong>
                                        </label>
                                    </div>
                                </div>
                               
                                </div>
                            </div>
                        </div>

                        
                        <div id="visa-details" class="border rounded p-3 mb-4" style="display: none; background: #f8f9fa;">
                            <h5 class="mb-3 text-primary"><i class="fas fa-credit-card me-2"></i>{% trans "Visa Details" %}</h5>

                            
                            <div class="mb-3">
                                <label for="card_number" class="form-label">{% trans "Card Number" %}</label>
                                <input type="text" name="card_number" id="card_number"
                                       class="form-control" maxlength="16" pattern="\d{16}"
                                       placeholder="Example: 4111111111111111"
                                       title="Enter 16 digits for Visa card only">
                            </div>

                            
                            <div class="mb-3">
                                <label for="expiry_date" class="form-label">{% trans "Expiry Date (MM/YY)" %}</label>
                                <input type="text" name="expiry_date" id="expiry_date"
                                       class="form-control" maxlength="5"
                                       pattern="(0[1-9]|1[0-2])\/\d{2}"
                                       placeholder="05/27"
                                       title="Must be in format: 05/27">
                            </div>

                            
                            <div class="mb-3">
                                <label for="cvv" class="form-label">{% trans "CVV" %}</label>
                                <input type="text" name="cvv" id="cvv"
                                       class="form-control" maxlength="3"
                                       pattern="\d{3}"
                                       placeholder="123"
                                       title="Security code must be 3 digits only">
                            </div>
                        </div>

                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-check-circle me-2"></i>
                                {% trans "Complete Payment" %} - ${{ booking.total_amount }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            
            <div class="text-center mt-4">
                <a href="{% url 'booking_detail' booking.booking_id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>{% trans "Back to Booking Details" %}
                </a>
            </div>

        </div>
    </div>
</div>

<script>
    const visaOption = document.getElementById('visa_option');
    const cashOption = document.getElementById('cash_option');
    const visaDetails = document.getElementById('visa-details');
    const cardNumber = document.getElementById('card_number');
    const expiryDate = document.getElementById('expiry_date');
    const cvv = document.getElementById('cvv');
    const form = document.getElementById('payment-form');

    // Show/Hide Visa form
    visaOption.addEventListener('change', () => {
        visaDetails.style.display = 'block';
        cardNumber.required = true;
        expiryDate.required = true;
        cvv.required = true;
    });

    cashOption.addEventListener('change', () => {
        visaDetails.style.display = 'none';
        cardNumber.required = false;
        expiryDate.required = false;
        cvv.required = false;
        cardNumber.value = '';
        expiryDate.value = '';
        cvv.value = '';
    });

    // Prevent letters or symbols in inputs
    cardNumber.addEventListener('input', function () {
        this.value = this.value.replace(/[^0-9]/g, '').slice(0, 16);
    });
    cvv.addEventListener('input', function () {
        this.value = this.value.replace(/[^0-9]/g, '').slice(0, 3);
    });
    expiryDate.addEventListener('input', function () {
        this.value = this.value.replace(/[^0-9/]/g, '').slice(0, 5);
    });

    // ? Strong validation before submission
    form.addEventListener('submit', function (e) {
        if (visaOption.checked) {
            const card = cardNumber.value.trim();
            const cvvVal = cvv.value.trim();
            const exp = expiryDate.value.trim();

            // Validate card number (must be 16 digits)
            if (!/^\d{16}$/.test(card)) {
                alert("Card number must be exactly 16 digits.");
                e.preventDefault();
                return;
            }

            // Validate CVV (must be 3 digits)
            if (!/^\d{3}$/.test(cvvVal)) {
                alert("CVV must be exactly 3 digits.");
                e.preventDefault();
                return;
            }

            // Validate expiry format and check not expired
            const match = exp.match(/^(0[1-9]|1[0-2])\/(\d{2})$/);
            if (!match) {
                alert("Expiry date must be in MM/YY format.");
                e.preventDefault();
                return;
            }

            const month = parseInt(match[1]);
            const year = parseInt("20" + match[2]);

            // Create date for end of expiry month
            const expiry = new Date(year, month); // automatically rolls to next month start
            const today = new Date();

            // Compare expiry > 
            if (expiry <= today) {
                alert("Card expiry date cannot be in the past.");
                e.preventDefault();
                return;
            }
        }
    });
</script>

{% endblock %}


